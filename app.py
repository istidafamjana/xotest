from flask import Flask, request, jsonify, render_template_string, redirect, url_for, session, flash
from werkzeug.security import generate_password_hash, check_password_hash
import requests
import google.generativeai as genai
import logging
import tempfile
import urllib.request
import os
import hashlib
import time
import uuid
import json
from datetime import datetime
from threading import Lock
from functools import wraps

# ======== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ========
app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY', 'dev-secret-key-123')
app.config['PERMANENT_SESSION_LIFETIME'] = 3600 * 5  # 5 Ø³Ø§Ø¹Ø§Øª

# ======== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¬Ù„ ========
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ======== Ù…ÙØ§ØªÙŠØ­ ÙˆØªÙ‡ÙŠØ¦Ø© API ========
PAGE_ACCESS_TOKEN = "EAAOeBunVPqoBO5CLPaCIKVr21FqLLQqZBZAi8AnGYqurjwSOEki2ZC2IgrVtYZAeJtZC5ZAgmOTCPNzpEOsJiGZCQ7fZAXO7FX0AO4B1GpUTyQajZBGNzZA8KH2IGzSB3VLmBeTxNFG4k7VRUY1Svp4ZCiJDaZBSzEuBecZATZBR0f2faXamwLvONJwmDmSD6Oahkp1bhxwU3egCKJ8zuoy7GbZCUEWXyjNxwZDZD"
VERIFY_TOKEN = "d51ee4e3183dbbd9a27b7d2c1af8c655"
GEMINI_API_KEY = "AIzaSyA1TKhF1NQskLCqXR3O_cpISpTn9I8R-IU"

# ======== ØªÙ‡ÙŠØ¦Ø© Ù†Ù…ÙˆØ°Ø¬ Gemini ========
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-1.5-flash')

# ======== ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ========
conversations = {}
users_db = {}
CONVERSATION_TIMEOUT = 5 * 60 * 60  # 5 Ø³Ø§Ø¹Ø§Øª
data_lock = Lock()

# ======== Ù‚ÙˆØ§Ù„Ø¨ HTML ========
BASE_HTML = '''
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 0; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        header { background: #4285f4; color: white; padding: 10px 0; text-align: center; }
        nav { background: #333; overflow: hidden; }
        nav a { float: right; color: white; text-align: center; padding: 14px 16px; text-decoration: none; }
        nav a:hover { background: #ddd; color: black; }
        .flash { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #dff0d8; color: #3c763d; }
        .error { background: #f2dede; color: #a94442; }
        form { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #4285f4; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        button:hover { background: #3367d6; }
        .chat-container { background: white; height: 500px; overflow-y: scroll; padding: 20px; border-radius: 5px; }
        .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .user-message { background: #e3f2fd; text-align: left; }
        .bot-message { background: #f1f1f1; text-align: right; }
    </style>
</head>
<body>
    <header>
        <h1>Ù†Ø¸Ø§Ù… OTH AI</h1>
    </header>
    <nav>
        {% if 'user_id' in session %}
            <a href="{{ url_for('logout') }}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
            <a href="{{ url_for('chat') }}">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</a>
            <a href="{{ url_for('dashboard') }}">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        {% else %}
            <a href="{{ url_for('login') }}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
            <a href="{{ url_for('register') }}">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>
        {% endif %}
        <a href="{{ url_for('home') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </nav>
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>
</body>
</html>
'''

HOME_HTML = '''
{% extends "base.html" %}
{% block content %}
    <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ OTH</h2>
    <p>Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini AI</p>
    {% if 'user_id' not in session %}
        <p>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§ Ù„Ù„Ø¨Ø¯Ø¡</p>
    {% endif %}
{% endblock %}
'''

LOGIN_HTML = '''
{% extends "base.html" %}
{% block content %}
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <form method="POST" action="{{ url_for('login') }}">
        <input type="text" name="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
        <input type="password" name="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
        <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>
{% endblock %}
'''

REGISTER_HTML = '''
{% extends "base.html" %}
{% block content %}
    <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <form method="POST" action="{{ url_for('register') }}">
        <input type="text" name="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" required>
        <input type="password" name="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" required>
        <input type="password" name="confirm_password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
        <button type="submit">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </form>
{% endblock %}
'''

DASHBOARD_HTML = '''
{% extends "base.html" %}
{% block content %}
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <p>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ {{ username }}!</p>
    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©: {{ active_chats }}</p>
    <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {{ join_date }}</p>
    <a href="{{ url_for('chat') }}" class="button">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</a>
{% endblock %}
'''

CHAT_HTML = '''
{% extends "base.html" %}
{% block content %}
    <h2>Ø¯Ø±Ø¯Ø´Ø© OTH AI</h2>
    <div class="chat-container" id="chat-box">
        {% for msg in conversation %}
            <div class="message {% if 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:' in msg %}user-message{% else %}bot-message{% endif %}">
                {{ msg }}
            </div>
        {% endfor %}
    </div>
    <form id="chat-form" onsubmit="sendMessage(); return false;">
        <input type="text" id="user-message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." required>
        <button type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
    </form>
    <script>
        function sendMessage() {
            const message = document.getElementById('user-message').value;
            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML += `
                    <div class="message user-message">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${message}</div>
                    <div class="message bot-message">Ø§Ù„Ø¨ÙˆØª: ${data.reply}</div>
                `;
                document.getElementById('user-message').value = '';
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }
    </script>
{% endblock %}
'''

# ======== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ========
def get_user_id(sender_id):
    return hashlib.md5(sender_id.encode()).hexdigest()

def setup_messenger_profile():
    url = f"https://graph.facebook.com/v17.0/me/messenger_profile?access_token={PAGE_ACCESS_TOKEN}"
    payload = {
        "get_started": {"payload": "GET_STARTED"},
        "persistent_menu": [
            {
                "locale": "default",
                "composer_input_disabled": False,
                "call_to_actions": [
                    {
                        "type": "web_url",
                        "title": "ğŸŒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙˆÙŠØ¨",
                        "url": "https://your-app.vercel.app/chat",
                        "webview_height_ratio": "full",
                        "messenger_extensions": True
                    },
                    {
                        "type": "postback",
                        "title": "ğŸ†˜ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©",
                        "payload": "HELP_CMD"
                    }
                ]
            }
        ],
        "whitelisted_domains": ["https://your-app.vercel.app"],
        "greeting": [
            {
                "locale": "default",
                "text": "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª OTH IA! ğŸ’"
            }
        ]
    }
    try:
        response = requests.post(url, json=payload)
        response.raise_for_status()
        logger.info("ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø§Ø³Ù†Ø¬Ø± Ø¨Ù†Ø¬Ø§Ø­")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: {str(e)}")

def download_image(url):
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        req = urllib.request.Request(url, headers=headers)
        with tempfile.NamedTemporaryFile(delete=False, suffix='.jpg') as tmp_file:
            with urllib.request.urlopen(req) as response:
                tmp_file.write(response.read())
            return tmp_file.name
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: {str(e)}")
        return None

def analyze_image(image_path, context=None):
    try:
        img = genai.upload_file(image_path)
        prompt = "Ø­Ù„Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù‚Ø© ÙˆÙ‚Ø¯Ù… ÙˆØµÙØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹:"
        if context:
            prompt = f"Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:\n{context}\n{prompt}"
        response = model.generate_content([prompt, img])
        return response.text
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: {str(e)}")
        return None
    finally:
        if image_path and os.path.exists(image_path):
            os.unlink(image_path)

def send_message(recipient_id, message_text, buttons=None):
    url = f"https://graph.facebook.com/v17.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {
        "recipient": {"id": recipient_id},
        "message": {"text": message_text} if not buttons else {
            "attachment": {
                "type": "template",
                "payload": {
                    "template_type": "button",
                    "text": message_text,
                    "buttons": buttons
                }
            }
        },
        "messaging_type": "RESPONSE"
    }
    try:
        response = requests.post(url, json=payload)
        response.raise_for_status()
        return True
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {str(e)}")
        return False

def cleanup_old_conversations():
    current_time = time.time()
    with data_lock:
        for user_id in list(conversations.keys()):
            if current_time - conversations[user_id]["last_active"] > CONVERSATION_TIMEOUT:
                del conversations[user_id]
                logger.info(f"ØªÙ… Ø­Ø°Ù Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù„Ø©")

# ======== Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ÙˆÙŠØ¨ ========
@app.route('/')
def home():
    return render_template_string(BASE_HTML + HOME_HTML, title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        
        with data_lock:
            user = users_db.get(username)
            if user and check_password_hash(user['password'], password):
                session['user_id'] = user['id']
                session['username'] = username
                session['session_id'] = str(uuid.uuid4())
                session.permanent = True
                
                if user['id'] not in conversations:
                    conversations[user['id']] = {
                        "history": ["Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"],
                        "last_active": time.time()
                    }
                
                flash('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success')
                return redirect(url_for('dashboard'))
            else:
                flash('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'danger')
    
    return render_template_string(BASE_HTML + LOGIN_HTML, title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")

@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        confirm_password = request.form['confirm_password']
        
        if len(username) < 4 or len(password) < 6:
            flash('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù', 'danger')
            return redirect(url_for('register'))
        
        if password != confirm_password:
            flash('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©', 'danger')
            return redirect(url_for('register'))
        
        with data_lock:
            if username in users_db:
                flash('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'danger')
            else:
                user_id = str(uuid.uuid4())
                users_db[username] = {
                    'id': user_id,
                    'username': username,
                    'password': generate_password_hash(password),
                    'created_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
                conversations[user_id] = {
                    "history": ["Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"],
                    "last_active": time.time()
                }
                
                flash('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†', 'success')
                return redirect(url_for('login'))
    
    return render_template_string(BASE_HTML + REGISTER_HTML, title="Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨")

@app.route('/logout')
def logout():
    user_id = session.get('user_id')
    with data_lock:
        if user_id in conversations:
            del conversations[user_id]
    
    session.clear()
    flash('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'info')
    return redirect(url_for('home'))

@app.route('/dashboard')
def dashboard():
    if 'user_id' not in session:
        return redirect(url_for('login'))
    
    with data_lock:
        active_chats = len(conversations)
        user_data = next((u for u in users_db.values() if u['id'] == session['user_id']), None)
    
    if not user_data:
        session.clear()
        return redirect(url_for('login'))
    
    return render_template_string(
        BASE_HTML + DASHBOARD_HTML,
        title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
        username=user_data['username'],
        active_chats=active_chats,
        join_date=user_data.get('created_at', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')
    )

@app.route('/chat')
def chat():
    if 'user_id' not in session:
        return redirect(url_for('login'))
    
    user_id = session['user_id']
    with data_lock:
        if user_id not in conversations:
            conversations[user_id] = {
                "history": ["Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"],
                "last_active": time.time()
            }
        
        conversation = conversations[user_id]["history"]
    
    return render_template_string(
        BASE_HTML + CHAT_HTML,
        title="Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©",
        conversation=conversation
    )

@app.route('/api/chat', methods=['POST'])
def api_chat():
    if 'user_id' not in session:
        return jsonify({"error": "ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡"}), 401
    
    try:
        data = request.json
        user_message = data.get('message', '').strip()
        
        if not user_message:
            return jsonify({"reply": "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØµØ§Ù„Ø­Ø©"}), 400
        
        user_id = session['user_id']
        
        with data_lock:
            if user_id not in conversations:
                conversations[user_id] = {
                    "history": ["Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"],
                    "last_active": time.time()
                }
            
            conversations[user_id]["last_active"] = time.time()
            conversations[user_id]["history"].append(f"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_message}")
            
            context = "\n".join(conversations[user_id]["history"][-5:])
            prompt = f"{context}\n\nØ§Ù„Ø³Ø¤Ø§Ù„: {user_message}" if context else user_message
            response = model.generate_content(prompt)
            reply = response.text
            
            conversations[user_id]["history"].append(f"Ø§Ù„Ø¨ÙˆØª: {reply}")
            
            return jsonify({"reply": reply}), 200
            
    except Exception as e:
        logger.error(f"API Error: {str(e)}")
        return jsonify({"reply": "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ"}), 500

# ======== Ù…Ø³Ø§Ø±Ø§Øª ÙÙŠØ³Ø¨ÙˆÙƒ (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„) ========
@app.route('/webhook', methods=['GET', 'POST'])
def webhook():
    if request.method == 'GET':
        verify_token = request.args.get('hub.verify_token')
        if verify_token == VERIFY_TOKEN:
            setup_messenger_profile()
            return request.args.get('hub.challenge')
        return "Verification failed", 403
    
    data = request.get_json()
    try:
        for entry in data.get('entry', []):
            for event in entry.get('messaging', []):
                sender_id = event['sender']['id']
                user_id = get_user_id(sender_id)
                current_time = time.time()
                
                cleanup_old_conversations()
                
                if 'postback' in event:
                    handle_command(sender_id, user_id, event['postback']['payload'])
                    continue
                    
                if 'message' in event:
                    message = event['message']
                    
                    with data_lock:
                        if user_id not in conversations:
                            conversations[user_id] = {
                                "history": ["Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"],
                                "last_active": current_time
                            }
                            send_message(sender_id, "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª OTH IA! ğŸ’\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø£Ùˆ ØµÙˆØ±Ø© ÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ.")
                        
                        conversations[user_id]["last_active"] = current_time
                        
                        if 'attachments' in message:
                            for attachment in message['attachments']:
                                if attachment['type'] == 'image':
                                    send_message(sender_id, "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...")
                                    image_url = attachment['payload']['url']
                                    image_path = download_image(image_url)
                                    
                                    if image_path:
                                        context = "\n".join(conversations[user_id]["history"][-5:])
                                        analysis = analyze_image(image_path, context)
                                        
                                        if analysis:
                                            conversations[user_id]["history"].append(f"ØµÙˆØ±Ø©: {analysis[:200]}...")
                                            send_message(sender_id, f"ğŸ“¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:\n\n{analysis}")
                                        else:
                                            send_message(sender_id, "âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©")
                            continue
                        
                        if 'text' in message:
                            user_message = message['text'].strip()
                            
                            if user_message.lower() in ['Ù…Ø³Ø§Ø¹Ø¯Ø©', 'help']:
                                send_message(sender_id, "ğŸ†˜ Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©:\n\nâ€¢ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©\nâ€¢ Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§\nâ€¢ /new Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©")
                            else:
                                try:
                                    context = "\n".join(conversations[user_id]["history"][-5:])
                                    prompt = f"{context}\n\nØ§Ù„Ø³Ø¤Ø§Ù„: {user_message}" if context else user_message
                                    
                                    response = model.generate_content(prompt)
                                    reply = response.text
                                    
                                    conversations[user_id]["history"].append(f"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_message}")
                                    conversations[user_id]["history"].append(f"Ø§Ù„Ø¨ÙˆØª: {reply}")
                                    
                                    send_message(sender_id, reply)
                                except Exception as e:
                                    logger.error(f"AI Error: {str(e)}")
                                    send_message(sender_id, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹")
    
    except Exception as e:
        logger.error(f"Webhook error: {str(e)}")
    
    return jsonify({"status": "ok"}), 200

def handle_command(sender_id, user_id, command):
    if command == "GET_STARTED":
        send_message(sender_id, "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ OTH IA! ğŸ’\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø£Ùˆ ØµÙˆØ±Ø© ÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ.")
    elif command == "HELP_CMD":
        send_message(sender_id, "ğŸ†˜ Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©:\n\nâ€¢ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©\nâ€¢ Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§\nâ€¢ /new Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©")

@app.errorhandler(404)
def page_not_found(e):
    return render_template_string(BASE_HTML + "<h2>Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h2>", title="404"), 404

# ======== Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ========
def periodic_cleanup():
    while True:
        time.sleep(3600)
        cleanup_old_conversations()

if __name__ == '__main__':
    import threading
    cleanup_thread = threading.Thread(target=periodic_cleanup)
    cleanup_thread.daemon = True
    cleanup_thread.start()
    
    setup_messenger_profile()
    app.run(threaded=True)
